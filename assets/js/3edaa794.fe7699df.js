"use strict";(self.webpackChunkflom_github_io=self.webpackChunkflom_github_io||[]).push([[615],{3905:(e,t,n)=>{n.d(t,{Zo:()=>m,kt:()=>u});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},m=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),c=p(n),h=a,u=c["".concat(s,".").concat(h)]||c[h]||d[h]||o;return n?r.createElement(u,i(i({ref:t},m),{},{components:n})):r.createElement(u,i({ref:t},m))}));function u(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:a,i[1]=l;for(var p=2;p<o;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},4402:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var r=n(7462),a=(n(7294),n(3905));const o={title:"Poor Man's Zero Downtime Deployment in IIS",authors:"flom",tags:["IIS","Windows","DevOps"]},i=void 0,l={permalink:"/blog/2018/12/10/zero-downtime-iis-deployment",source:"@site/blog/2018-12-10-zero-downtime-iis-deployment.md",title:"Poor Man's Zero Downtime Deployment in IIS",description:"For my side project I'm deploying two projects (Angular Frontend and ASP.NET Core API) to a Windows Server with IIS installed.",date:"2018-12-10T00:00:00.000Z",formattedDate:"December 10, 2018",tags:[{label:"IIS",permalink:"/blog/tags/iis"},{label:"Windows",permalink:"/blog/tags/windows"},{label:"DevOps",permalink:"/blog/tags/dev-ops"}],readingTime:2.485,hasTruncateMarker:!1,authors:[{name:"Florian Mladitsch",title:"Software Developer",url:"https://github.com/flom",imageURL:"https://github.com/flom.png",key:"flom"}],frontMatter:{title:"Poor Man's Zero Downtime Deployment in IIS",authors:"flom",tags:["IIS","Windows","DevOps"]},prevItem:{title:"Open API",permalink:"/blog/2019/07/30/open-api"},nextItem:{title:"Angular: Synchronize component properties with URL query parameters",permalink:"/blog/2018/07/09/angular-synchronize-properties-with-url-parameters"}},s={authorsImageUrls:[void 0]},p=[],m={toc:p},c="wrapper";function d(e){let{components:t,...n}=e;return(0,a.kt)(c,(0,r.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"For my side project I'm deploying two projects (Angular Frontend and ASP.NET Core API) to a Windows Server with IIS installed.\nIn my current setup each project is deployed automatically via ",(0,a.kt)("a",{parentName:"p",href:"https://www.jetbrains.com/teamcity/"},"TeamCity")," whenever I check\nsomething into the master branch. "),(0,a.kt)("p",null,"One way to do such a deployment is to use an build server tasks that handles the deployment to IIS (e.g. via Web Deploy).\nWhat those tasks are basically doing is copying files (latest binaries of the application) to the physical path of the IIS site.\nIf you enable more fancy options on those deployment tasks then this step might include taking the IIS site offline and/or deleting\nall old files prior to deployment."),(0,a.kt)("p",null,"The problem I had with this approach is that the application is either offline during deployment or in an inconsistent state while\nfiles are being copied to the IIS sites physical location.\nFor my small side project I wanted to have a (nearly) zero downtime deployment in IIS."),(0,a.kt)("p",null,"So what I wanted to do is to copy my application binaries (that I want to serve via IIS) to an 'arbitrary' folder and then tell\nIIS to serve the application from this new folder after the copy job is done."),(0,a.kt)("p",null,"Thanks to ",(0,a.kt)("strong",{parentName:"p"},"AppCmd.exe")," this is actually pretty easy to achieve.\n",(0,a.kt)("strong",{parentName:"p"},"AppCmd.exe")," allows you to manage your IIS Server via command line.\nA introduction and more complete documentation can be found here: ",(0,a.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/iis/get-started/getting-started-with-iis/getting-started-with-appcmdexe"},"https://docs.microsoft.com/en-us/iis/get-started/getting-started-with-iis/getting-started-with-appcmdexe"),"."),(0,a.kt)("p",null,"The initial state of the folder structure looked something like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"edrinks-webapp\n+-- release_0\n|   +-- index.html\n|   +-- app.js\n")),(0,a.kt)("p",null,"In each deployment I'm creating a new folder called ",(0,a.kt)("em",{parentName:"p"},"release_x")," where a simple task is copying the application into it\nwhile increasing a counter (handled by TeamCity variables):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"edrinks-webapp\n+-- release_0\n|   +-- index.html\n|   +-- app.js\n+-- release_1\n|   +-- index.html\n|   +--app.js\n")),(0,a.kt)("p",null,"After the files have been copied I call AppCmd.exe to change the folder from where the IIS page is served from:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'\nC:\\Windows\\System32\\inetsrv\\appcmd.exe set vdir "E-Drinks/" -physicalPath:"edrinks-webapp\\release_1"\n\n')),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},'vdir "E-Drinks/"')," identifies the application name given in IIS and ",(0,a.kt)("inlineCode",{parentName:"p"},'-physicalPath:"..."')," is the actual location\non the hard drive."),(0,a.kt)("p",null,"This process goes on for each each deployment:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"edrinks-webapp\n+-- release_0\n|   +-- index.html\n|   +-- app.js\n+-- release_1\n|   +-- index.html\n|   +--app.js\n+-- release_2\n|   +-- index.html\n|   +-- app.js\n|   +-- new_app.css\n+-- release_x\n|   +-- index.html\n|   +-- ...\n")),(0,a.kt)("p",null,"In order to prevent having too many old application versions I execute a small cleanup task which keeps the last ",(0,a.kt)("em",{parentName:"p"},"x"),"\nversions and deletes the remaining old versions.\nIn my case this is done with following python script:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"import os, sys, shutil\n\ndef cleanup(keep):\n    print('keep last {} versions'.format(keep))\n    releases = []\n    for item in os.listdir():\n        if item.startswith('release_'):\n            releases.append((item, os.path.getctime(item)))\n    releases.sort(key=lambda tup: tup[1], reverse=True)\n    for release in releases[keep:]:\n        print('removing {}'.format(release[0]))\n        shutil.rmtree(release[0])\n\nif __name__ == '__main__':\n    if len(sys.argv) >= 2:\n        try:\n            keep = int(sys.argv[1])\n            cleanup(keep)\n        except ValueError:\n            print('invalid parameter: {}'.format(sys.argv[1]))\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"python cleanup.py 10 # number of old versions to keep\n")))}d.isMDXComponent=!0}}]);